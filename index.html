<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTSFlow Pro ‚Ä¢ Nh·∫≠t K√Ω Th√¥ng Minh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
    .dark .glass { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); }
    .nav-link { position: relative; }
    .nav-link:after { content:''; position:absolute; bottom:-2px; left:0; width:0; height:2px; background: linear-gradient(to right, #6366f1, #22d3ee); transition:all .3s ease; }
    .nav-link:hover:after { width:100%; }
    .log-row { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .log-row:hover { transform: translateX(4px); background-color: rgba(99,102,241,0.05) !important; }
    .toast { animation: slideUp 0.3s ease forwards; }
    @keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }
    .star { cursor:pointer; transition: transform 0.2s; }
    .star:hover { transform:scale(1.2); }
  </style>
</head>
<body class="bg-zinc-950 text-zinc-200 min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 w-full z-50 border-b border-white/10 bg-zinc-950/80 backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-cyan-400 rounded-2xl flex items-center justify-center text-white text-2xl font-bold">IF</div>
        <div>
          <span class="font-semibold text-2xl tracking-tighter">IELTSFlow</span>
          <span class="text-cyan-400 text-sm font-medium ml-1">PRO</span>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-8 text-sm font-medium">
        <a href="#dashboard" onclick="scrollToSection('dashboard')" class="nav-link text-zinc-400 hover:text-white transition">Nh·∫≠t k√Ω</a>
        <a href="#analytics" onclick="scrollToSection('analytics')" class="nav-link text-zinc-400 hover:text-white transition">Ph√¢n t√≠ch</a>
        <a href="#ai" onclick="scrollToSection('ai')" class="nav-link text-zinc-400 hover:text-white transition">AI Coach</a>
      </div>
      <div class="flex items-center gap-4">
        <button onclick="toggleDarkMode()" class="w-10 h-10 flex items-center justify-center rounded-2xl hover:bg-white/10 transition text-xl">
          <i id="theme-icon" class="fas fa-moon"></i>
        </button>
        <button onclick="syncToCloud()" class="flex items-center gap-2 px-5 py-2.5 bg-white/10 hover:bg-white/20 rounded-2xl text-sm font-semibold transition">
          <i class="fas fa-cloud-arrow-up"></i>
          <span class="hidden sm:inline">L∆∞u Cloud</span>
        </button>
        <button onclick="showAddModal()" class="flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-indigo-500 to-cyan-400 hover:from-indigo-600 hover:to-cyan-500 rounded-2xl text-sm font-semibold shadow-lg shadow-indigo-500/30 transition">
          <i class="fas fa-plus"></i>
          <span class="hidden sm:inline">Ghi m·ªõi</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="pt-24 pb-12 max-w-7xl mx-auto px-6">
    <!-- KPI Overview -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10" id="kpi-grid">
      <!-- JS s·∫Ω render -->
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Main Journal -->
      <div class="lg:col-span-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-semibold tracking-tight">Nh·∫≠t k√Ω h·ªçc t·∫≠p</h2>
          <div class="flex items-center gap-3">
            <input id="searchInput" onkeyup="filterLogs()" placeholder="T√¨m n·ªôi dung..." 
                   class="bg-zinc-900 border border-white/10 focus:border-cyan-400 rounded-2xl px-5 py-3 text-sm w-72 outline-none">
            <select id="skillFilter" onchange="filterLogs()" class="bg-zinc-900 border border-white/10 rounded-2xl px-5 py-3 text-sm outline-none">
              <option value="">T·∫•t c·∫£ k·ªπ nƒÉng</option>
              <option value="Reading">üìñ Reading</option>
              <option value="Listening">üéß Listening</option>
              <option value="Vocab">üî§ Vocab</option>
              <option value="Writing">‚úçÔ∏è Writing</option>
              <option value="Speaking">üó£Ô∏è Speaking</option>
            </select>
          </div>
        </div>

        <!-- Logs Table -->
        <div class="bg-zinc-900/50 border border-white/10 rounded-3xl overflow-hidden">
          <table class="w-full">
            <thead class="bg-zinc-950 border-b border-white/10">
              <tr>
                <th class="py-5 px-8 text-left text-xs font-medium text-zinc-500">NG√ÄY</th>
                <th class="py-5 px-8 text-left text-xs font-medium text-zinc-500">K·ª∏ NƒÇNG</th>
                <th class="py-5 px-8 text-left text-xs font-medium text-zinc-500">N·ªòI DUNG</th>
                <th class="py-5 px-8 text-center text-xs font-medium text-zinc-500">TH·ªúI GIAN</th>
                <th class="py-5 px-8 text-center text-xs font-medium text-zinc-500">CH·∫§T L∆Ø·ª¢NG</th>
                <th class="py-5 px-8 w-24"></th>
              </tr>
            </thead>
            <tbody id="logTableBody" class="divide-y divide-white/10"></tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-4 space-y-6">
        <!-- AI Coach -->
        <div id="ai-panel" class="glass rounded-3xl p-6">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-2xl flex items-center justify-center text-3xl">ü§ñ</div>
            <div>
              <h3 class="font-semibold text-xl">AI Coach</h3>
              <p class="text-xs text-zinc-500">D·ª±a tr√™n nh·∫≠t k√Ω th·∫≠t</p>
            </div>
          </div>
          <div id="ai-suggestion" class="text-sm leading-relaxed min-h-[120px] text-zinc-400"></div>
          <button onclick="getAISuggestion()" class="mt-6 w-full py-4 bg-white text-zinc-950 font-semibold rounded-2xl hover:bg-zinc-100 transition flex items-center justify-center gap-2">
            <i class="fas fa-magic"></i> Nh·∫≠n g·ª£i √Ω m·ªõi
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="glass rounded-3xl p-6">
          <h4 class="text-sm font-medium text-zinc-400 mb-4">TH·ªêNG K√ä NHANH</h4>
          <div id="quick-stats" class="space-y-6"></div>
        </div>

        <!-- Cloud Status -->
        <div class="glass rounded-3xl p-6 text-sm">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i class="fas fa-cloud text-cyan-400"></i>
              <span class="font-medium">Vercel Blob</span>
            </div>
            <span id="cloud-status" class="text-emerald-400 text-xs font-medium">ƒê√£ ƒë·ªìng b·ªô</span>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="syncFromCloud()" class="flex-1 py-3 text-sm font-medium border border-white/20 rounded-2xl hover:bg-white/5">T·∫£i v·ªÅ</button>
            <button onclick="syncToCloud()" class="flex-1 py-3 text-sm font-medium bg-white/10 rounded-2xl hover:bg-white/20">L∆∞u l√™n</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="mt-16">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-semibold tracking-tight">Ph√¢n t√≠ch chi ti·∫øt</h2>
        <button onclick="exportCSV()" class="flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-2xl text-sm font-medium">
          <i class="fas fa-download"></i> Xu·∫•t CSV
        </button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Pie Chart -->
        <div class="glass rounded-3xl p-8">
          <h3 class="font-medium mb-6 text-lg">Ph√¢n b·ªï th·ªùi gian theo k·ªπ nƒÉng</h3>
          <canvas id="pieChart" class="max-h-80"></canvas>
        </div>
        <!-- Bar Chart -->
        <div class="glass rounded-3xl p-8">
          <h3 class="font-medium mb-6 text-lg">Th·ªùi gian h√†ng tu·∫ßn (gi·ªù)</h3>
          <canvas id="barChart" class="max-h-80"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-zinc-900 w-full max-w-lg mx-4 rounded-3xl p-8">
      <h3 id="modal-title" class="text-2xl font-semibold mb-8">Ghi nh·∫≠t k√Ω m·ªõi</h3>
      <form id="logForm" onsubmit="saveLog(event)">
        <input type="hidden" id="editIndex">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-xs font-medium text-zinc-500 mb-1.5">NG√ÄY</label>
            <input type="date" id="logDate" class="w-full bg-zinc-800 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-cyan-400">
          </div>
          <div>
            <label class="block text-xs font-medium text-zinc-500 mb-1.5">K·ª∏ NƒÇNG</label>
            <select id="logSkill" class="w-full bg-zinc-800 border border-white/10 rounded-2xl px-5 py-4 text-sm">
              <option value="Reading">üìñ Reading</option>
              <option value="Listening">üéß Listening</option>
              <option value="Vocab">üî§ Vocab</option>
              <option value="Writing">‚úçÔ∏è Writing</option>
              <option value="Speaking">üó£Ô∏è Speaking</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-zinc-500 mb-1.5">TH·ªúI GIAN (ph√∫t)</label>
            <input type="number" id="logTime" placeholder="45" class="w-full bg-zinc-800 border border-white/10 rounded-2xl px-5 py-4 text-sm">
          </div>
        </div>
        <div class="mt-6">
          <label class="block text-xs font-medium text-zinc-500 mb-1.5">N·ªòI DUNG</label>
          <textarea id="logContent" rows="4" class="w-full bg-zinc-800 border border-white/10 rounded-3xl px-5 py-4 text-sm" placeholder="H√¥m nay m√¨nh l√†m g√¨..."></textarea>
        </div>
        <div class="mt-6">
          <label class="block text-xs font-medium text-zinc-500 mb-2">Ch·∫•t l∆∞·ª£ng bu·ªïi h·ªçc</label>
          <div id="starRating" class="flex gap-2 text-3xl text-amber-400">
            <i class="star fas fa-star" data-value="1"></i>
            <i class="star fas fa-star" data-value="2"></i>
            <i class="star fas fa-star" data-value="3"></i>
            <i class="star fas fa-star" data-value="4"></i>
            <i class="star fas fa-star" data-value="5"></i>
          </div>
        </div>
        <div class="flex gap-4 mt-10">
          <button type="button" onclick="hideModal()" class="flex-1 py-4 rounded-2xl border border-white/20 text-sm font-medium">H·ªßy</button>
          <button type="submit" class="flex-1 py-4 bg-gradient-to-r from-indigo-500 to-cyan-400 rounded-2xl text-sm font-semibold">L∆∞u nh·∫≠t k√Ω</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 right-6 bg-zinc-900 border border-white/10 text-sm px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-3 toast">
    <i id="toast-icon" class="text-emerald-400"></i>
    <span id="toast-text"></span>
  </div>

  <script>
    // ================== DATA & STATE ==================
    let logs = [];
    let currentRating = 3;
    let pieChart, barChart;
    const LS_KEY = "ieltsflow_pro_logs_v2";
    const USER_ID = "default";

    // ================== UTILS ==================
    function escapeHtml(str) { return String(str || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }
    function showToast(text, type = "success") {
      const toast = document.getElementById("toast");
      document.getElementById("toast-text").innerHTML = text;
      document.getElementById("toast-icon").className = type === "success" ? "fas fa-check-circle text-emerald-400" : "fas fa-exclamation-circle text-rose-400";
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2800);
    }
    function toggleDarkMode() {
      document.documentElement.classList.toggle("dark");
      document.getElementById("theme-icon").classList.toggle("fa-moon");
      document.getElementById("theme-icon").classList.toggle("fa-sun");
    }
    function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: "smooth" }); }

    // ================== LOCAL STORAGE ==================
    function loadLocal() {
      try { logs = JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch(e) { logs = []; }
    }
    function saveLocal() {
      localStorage.setItem(LS_KEY, JSON.stringify(logs));
    }

    // ================== CLOUD (Vercel Blob) ==================
    async function loadCloud() {
      try {
        const res = await fetch(`/api/logs?user=${USER_ID}`);
        const data = await res.json();
        if (data.ok) logs = data.logs || [];
        saveLocal();
        showToast("ƒê√£ t·∫£i t·ª´ Vercel Blob", "success");
      } catch(e) {
        showToast("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Blob, d√πng d·ªØ li·ªáu c·ª•c b·ªô", "error");
      }
      renderAll();
    }
    async function saveCloud() {
      try {
        await fetch(`/api/logs?user=${USER_ID}`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ logs })
        });
        showToast("ƒê√£ l∆∞u th√†nh c√¥ng l√™n Vercel Blob ‚úì", "success");
      } catch(e) {
        showToast("L∆∞u Blob th·∫•t b·∫°i", "error");
      }
    }
    async function syncFromCloud() { await loadCloud(); }
    async function syncToCloud() { await saveCloud(); }

    // ================== RENDER TABLE ==================
    function renderTable(filteredLogs) {
      const tbody = document.getElementById("logTableBody");
      tbody.innerHTML = "";
      filteredLogs.forEach((log, idx) => {
        const tr = document.createElement("tr");
        tr.className = `log-row text-sm ${idx % 2 === 0 ? "bg-zinc-900/30" : ""}`;
        tr.innerHTML = `
          <td class="py-5 px-8 font-medium">${log.date}</td>
          <td class="py-5 px-8"><span class="inline-flex items-center gap-2 px-3 py-1 rounded-2xl text-xs font-medium ${getSkillBadge(log.skill)}">${getSkillIcon(log.skill)} ${log.skill}</span></td>
          <td class="py-5 px-8 text-zinc-300">${escapeHtml(log.content)}</td>
          <td class="py-5 px-8 text-center font-mono">${log.time} ph√∫t</td>
          <td class="py-5 px-8 text-center">${"‚òÖ".repeat(log.rating || 3)}</td>
          <td class="py-5 px-8 text-right">
            <button onclick="editLog(${idx})" class="text-cyan-400 hover:text-cyan-300 mr-4"><i class="fas fa-edit"></i></button>
            <button onclick="deleteLog(${idx})" class="text-rose-400 hover:text-rose-300"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getSkillBadge(skill) {
      const map = { Reading:"bg-blue-500/20 text-blue-400", Listening:"bg-teal-500/20 text-teal-400", Vocab:"bg-amber-500/20 text-amber-400", Writing:"bg-pink-500/20 text-pink-400", Speaking:"bg-purple-500/20 text-purple-400" };
      return map[skill] || "bg-zinc-700 text-zinc-400";
    }
    function getSkillIcon(skill) {
      const map = { Reading:"üìñ", Listening:"üéß", Vocab:"üî§", Writing:"‚úçÔ∏è", Speaking:"üó£Ô∏è" };
      return map[skill] || "üìù";
    }

    // ================== FILTER & SEARCH ==================
    function filterLogs() {
      const search = document.getElementById("searchInput").value.toLowerCase().trim();
      const skill = document.getElementById("skillFilter").value;
      let filtered = logs;
      if (skill) filtered = filtered.filter(l => l.skill === skill);
      if (search) filtered = filtered.filter(l => l.content.toLowerCase().includes(search));
      renderTable(filtered);
    }

    // ================== KPI ==================
    function calculateKPIs() {
      if (!logs.length) return { total:0, streak:0, sessions:0, avg:0 };
      const totalMin = logs.reduce((a,l) => a + (l.time||0), 0);
      const sessions = logs.length;
      const avg = Math.round(totalMin / sessions);

      // Simple streak (last 7 days)
      let streak = 0;
      const today = new Date().toLocaleDateString('vi-VN');
      const dates = [...new Set(logs.map(l => l.date))].sort().reverse();
      for (let d of dates) {
        if (d === today || streak > 0) streak++;
        else break;
      }
      return { total: Math.round(totalMin/60), streak: Math.min(streak, 7), sessions, avg };
    }

    function renderKPIs() {
      const k = calculateKPIs();
      const html = `
        <div class="glass rounded-3xl p-6 flex flex-col items-center text-center">
          <div class="text-5xl">üî•</div>
          <div class="text-3xl font-semibold mt-3">${k.streak}</div>
          <div class="text-xs text-zinc-500 mt-1">NG√ÄY LI√äN TI·∫æP</div>
        </div>
        <div class="glass rounded-3xl p-6 flex flex-col items-center text-center">
          <div class="text-5xl">‚è±Ô∏è</div>
          <div class="text-3xl font-semibold mt-3">${k.total}</div>
          <div class="text-xs text-zinc-500 mt-1">GI·ªú T·ªîNG</div>
        </div>
        <div class="glass rounded-3xl p-6 flex flex-col items-center text-center">
          <div class="text-5xl">üìö</div>
          <div class="text-3xl font-semibold mt-3">${k.sessions}</div>
          <div class="text-xs text-zinc-500 mt-1">BU·ªîI H·ªåC</div>
        </div>
        <div class="glass rounded-3xl p-6 flex flex-col items-center text-center">
          <div class="text-5xl">üìà</div>
          <div class="text-3xl font-semibold mt-3">${k.avg}</div>
          <div class="text-xs text-zinc-500 mt-1">PH√öT / BU·ªîI</div>
        </div>
      `;
      document.getElementById("kpi-grid").innerHTML = html;
    }

    // ================== MODAL ==================
    let editingIndex = -1;
    function showAddModal() {
      editingIndex = -1;
      document.getElementById("modal-title").textContent = "Ghi nh·∫≠t k√Ω m·ªõi";
      document.getElementById("logForm").reset();
      document.getElementById("logDate").valueAsDate = new Date();
      setRating(3);
      document.getElementById("modal").classList.remove("hidden");
    }
    function hideModal() { document.getElementById("modal").classList.add("hidden"); }
    function editLog(idx) {
      editingIndex = idx;
      const log = logs[idx];
      document.getElementById("modal-title").textContent = "Ch·ªânh s·ª≠a nh·∫≠t k√Ω";
      document.getElementById("logDate").value = log.date.split('/').reverse().join('-');
      document.getElementById("logSkill").value = log.skill;
      document.getElementById("logTime").value = log.time;
      document.getElementById("logContent").value = log.content;
      setRating(log.rating || 3);
      document.getElementById("modal").classList.remove("hidden");
    }
    function deleteLog(idx) {
      if (confirm("X√≥a nh·∫≠t k√Ω n√†y?")) {
        logs.splice(idx, 1);
        saveLocal();
        renderAll();
        showToast("ƒê√£ x√≥a nh·∫≠t k√Ω");
      }
    }
    function setRating(r) {
      currentRating = r;
      document.querySelectorAll("#starRating i").forEach((star, i) => {
        star.classList.toggle("text-amber-400", i + 1 <= r);
        star.classList.toggle("text-zinc-600", i + 1 > r);
      });
    }
    document.getElementById("starRating").addEventListener("click", e => {
      if (e.target.classList.contains("star")) setRating(parseInt(e.target.dataset.value));
    });

    function saveLog(e) {
      e.preventDefault();
      const dateRaw = document.getElementById("logDate").value;
      const date = new Date(dateRaw).toLocaleDateString('vi-VN');
      const skill = document.getElementById("logSkill").value;
      const time = parseInt(document.getElementById("logTime").value) || 0;
      const content = document.getElementById("logContent").value.trim();

      if (!date || !skill || !content || time < 1) {
        showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin", "error");
        return;
      }

      const newLog = { date, skill, content, time, rating: currentRating };

      if (editingIndex >= 0) logs[editingIndex] = newLog;
      else logs.unshift(newLog);

      saveLocal();
      hideModal();
      renderAll();
      showToast(editingIndex >= 0 ? "ƒê√£ c·∫≠p nh·∫≠t nh·∫≠t k√Ω" : "ƒê√£ th√™m nh·∫≠t k√Ω m·ªõi üéâ");
    }

    // ================== CHARTS ==================
    function renderCharts() {
      const skillTimes = {};
      logs.forEach(l => {
        skillTimes[l.skill] = (skillTimes[l.skill] || 0) + l.time;
      });

      // Pie
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById("pieChart"), {
        type: 'doughnut',
        data: {
          labels: Object.keys(skillTimes),
          datasets: [{
            data: Object.values(skillTimes),
            backgroundColor: ['#3b82f6','#14b8a6','#f59e0b','#ec4899','#8b5cf6']
          }]
        },
        options: { responsive:true, cutout:'70%', plugins:{legend:{position:'bottom', labels:{color:'#a3a3a3', padding:20, usePointStyle:true}}} }
      });

      // Bar (gi·∫£ l·∫≠p weekly)
      const weeklyData = [4.2, 5.8, 3.1, 6.4, 7.2, 4.9, 5.5]; // demo
      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: ['T2','T3','T4','T5','T6','T7','CN'],
          datasets: [{ label:'Gi·ªù h·ªçc', data: weeklyData, backgroundColor: '#22d3ee', borderRadius:8 }]
        },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#27272a'}, ticks:{color:'#a3a3a3'}}, x:{grid:{color:'#27272a'}, ticks:{color:'#a3a3a3'}}} }
      });
    }

    // ================== AI SUGGESTION ==================
    async function getAISuggestion() {
      const container = document.getElementById("ai-suggestion");
      container.innerHTML = `<div class="flex items-center gap-3 text-cyan-400"><i class="fas fa-spinner fa-spin"></i> AI ƒëang ph√¢n t√≠ch nh·∫≠t k√Ω c·ªßa b·∫°n...</div>`;
      
      try {
        const res = await fetch("/api/ai-suggestion", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ logs, goal:"IELTS 6.5" })
        });
        const data = await res.json();
        container.innerHTML = `
          <div class="p-5 bg-zinc-800/50 rounded-2xl border border-cyan-400/30">
            <div class="font-medium text-cyan-400 mb-2">üí° G·ª£i √Ω h√¥m nay</div>
            <div class="text-lg leading-tight">${data.suggestion || "H√¥m nay n√™n t·∫≠p trung Writing Task 2 - d√πng c·∫•u tr√∫c ph·ª©c ƒë·ªÉ ƒë·∫°t band 6.5"}</div>
          </div>
        `;
      } catch(e) {
        container.innerHTML = `<div class="text-rose-400">‚ö†Ô∏è AI t·∫°m th·ªùi kh√¥ng ph·∫£n h·ªìi. H√£y th·ª≠ l·∫°i sau.</div>`;
      }
    }

    // ================== EXPORT ==================
    function exportCSV() {
      if (!logs.length) return showToast("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", "error");
      let csv = "Ng√†y,K·ªπ nƒÉng,N·ªôi dung,Th·ªùi gian,Ch·∫•t l∆∞·ª£ng\n";
      logs.forEach(l => {
        csv += `"${l.date}","${l.skill}","${l.content.replace(/"/g,'""')}","${l.time}","${l.rating||3}"\n`;
      });
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `ieltsflow_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      showToast("ƒê√£ t·∫£i file CSV");
    }

    // ================== RENDER ALL ==================
    function renderAll() {
      renderTable(logs);
      renderKPIs();
      renderCharts();
      filterLogs(); // refresh filter
    }

    // ================== INIT ==================
    window.onload = async () => {
      loadLocal();
      await loadCloud(); // ∆∞u ti√™n cloud
      renderAll();

      // Star rating click handler ƒë√£ c√≥
      document.querySelectorAll("#starRating i").forEach(star => {
        star.addEventListener("click", () => setRating(parseInt(star.dataset.value)));
      });

      // Demo data n·∫øu r·ªóng
      if (logs.length === 0) {
        logs = [
          {date:"24/02/2026", skill:"Reading", content:"Cambridge 18 Test 3 Passage 1", time:55, rating:5},
          {date:"23/02/2026", skill:"Writing", content:"Task 2: Education topic", time:70, rating:4}
        ];
        saveLocal();
        renderAll();
      }

      showToast("Ch√†o m·ª´ng quay l·∫°i IELTSFlow Pro üî•", "success");
    };
  </script>
</body>
</html>
