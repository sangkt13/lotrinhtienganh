<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS Tracker Pro - Nh·∫≠t K√Ω & Review</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Quicksand', sans-serif; scroll-behavior: smooth; }
    .blob-shape { animation: morph 8s ease-in-out infinite; border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
    @keyframes morph {
      0% { border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
      50% { border-radius: 30% 60% 70% 40%/50% 60% 30% 60%; }
      100% { border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
    }
    .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .nav-item { position: relative; }
    .nav-item::after { content:''; position:absolute; width:0; height:2px; bottom:-4px; left:0; background-color:#4F46E5; transition:width .3s ease-in-out; }
    .nav-item:hover::after { width:100%; }

    .sheet-table th {
      background:#F8FAFC; color:#64748B; font-weight:600; text-transform:uppercase;
      font-size:.75rem; letter-spacing:.05em; padding:12px 16px; border-bottom:2px solid #E2E8F0;
    }
    .sheet-table td { padding:16px; border-bottom:1px solid #F1F5F9; color:#334155; font-size:.9rem; }
    .sheet-table tr:last-child td { border-bottom:none; }
    .sheet-table tr:hover { background:#F8FAFC; }

    @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
    .animate-fade-in { animation: fadeIn .5s ease-out forwards; }
    .skill-progress-bar { transition: width 1s ease-in-out; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- Navbar -->
  <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md shadow-sm transition-all duration-300" id="navbar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex-shrink-0 flex items-center gap-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
            <i class="fa-solid fa-graduation-cap"></i>
          </div>
          <span class="font-bold text-2xl text-slate-800 tracking-tight">IELTS<span class="text-indigo-600">Flow</span></span>
        </div>

        <div class="hidden md:flex space-x-8">
          <a href="#" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">Trang ch·ªß</a>
          <a href="#dashboard" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">Nh·∫≠t k√Ω</a>
          <a href="#review" class="nav-item text-indigo-600 font-bold transition"><i class="fas fa-chart-pie mr-1"></i>Review</a>
          <a href="#roadmap" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">L·ªô tr√¨nh</a>
        </div>

        <div class="hidden md:flex items-center space-x-4">
          <button class="text-slate-600 hover:text-indigo-600 font-medium">ƒêƒÉng nh·∫≠p</button>
          <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-full font-medium shadow-lg shadow-indigo-500/30 transition transform hover:-translate-y-0.5">B·∫Øt ƒë·∫ßu ngay</button>
        </div>

        <div class="md:hidden flex items-center">
          <button onclick="toggleMobileMenu()" class="text-slate-600 hover:text-indigo-600">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100 p-4 space-y-3">
      <a href="#" class="block text-slate-600 hover:text-indigo-600 font-medium">Trang ch·ªß</a>
      <a href="#dashboard" class="block text-slate-600 hover:text-indigo-600 font-medium">Nh·∫≠t k√Ω</a>
      <a href="#review" class="block text-indigo-600 font-bold">Review</a>
      <a href="#roadmap" class="block text-slate-600 hover:text-indigo-600 font-medium">L·ªô tr√¨nh</a>
    </div>
  </nav>

  <!-- Hero -->
  <section class="pt-32 pb-20 overflow-hidden relative">
    <div class="absolute top-0 right-0 -mr-20 -mt-20 w-96 h-96 bg-indigo-100 rounded-full blur-3xl opacity-50"></div>
    <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-80 h-80 bg-teal-100 rounded-full blur-3xl opacity-50"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <div class="space-y-8">
          <div class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-sm font-semibold border border-indigo-100">
            üî• Ph∆∞∆°ng ph√°p Tracking hi·ªáu qu·∫£
          </div>

          <h1 class="text-5xl lg:text-6xl font-bold leading-tight text-slate-900">
            Theo d√µi th√≥i quen<br>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-teal-500">ƒê·ªçc & H·ªçc Ti·∫øng Anh</span>
          </h1>

          <p class="text-lg text-slate-600 leading-relaxed">
            Ghi l·∫°i t·ª´ng b√†i b√°o, t·ª´ng video v√† xem l·∫°i ch·∫∑ng ƒë∆∞·ªùng ph√°t tri·ªÉn k·ªπ nƒÉng c·ªßa b·∫°n m·ªói ng√†y.
          </p>

          <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="document.getElementById('dashboard').scrollIntoView({behavior:'smooth'})"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl shadow-indigo-500/30 transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
              <span>B·∫Øt ƒë·∫ßu ghi ch√©p</span>
              <i class="fas fa-pen-nib"></i>
            </button>

            <button onclick="syncFromCloud()"
              class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-8 py-4 rounded-xl font-bold text-lg shadow-sm transition flex items-center justify-center gap-2">
              <i class="fas fa-cloud-arrow-down text-indigo-600 text-xl"></i>
              <span>T·∫£i nh·∫≠t k√Ω t·ª´ Cloud</span>
            </button>
          </div>

          <div class="text-sm text-slate-500">
            <i class="fas fa-circle-info mr-1"></i>
            Cloud ƒëang l∆∞u tr√™n Vercel KV (Redis). Kh√¥ng c·∫ßn ƒë·∫∑t DB ri√™ng.
          </div>
        </div>

        <div class="relative lg:h-[600px] flex items-center justify-center">
          <div class="absolute w-full h-full bg-gradient-to-tr from-indigo-200 to-teal-100 blob-shape opacity-60"></div>
          <div class="relative z-10 w-full max-w-lg glass-card p-4 rounded-2xl shadow-2xl transform rotate-2 hover:rotate-0 transition duration-500">
            <div class="bg-white rounded-xl p-6 overflow-hidden">
              <div class="flex items-center gap-2 border-b pb-4 mb-4">
                <i class="fas fa-calendar-check text-indigo-600"></i>
                <span class="font-bold text-slate-700">Daily Habit Tracker</span>
              </div>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <div class="h-2 bg-indigo-200 rounded w-1/3"></div>
                  <div class="h-2 bg-green-200 rounded w-1/4"></div>
                </div>
                <div class="h-8 bg-slate-100 rounded w-full"></div>
                <div class="h-8 bg-slate-100 rounded w-5/6"></div>
                <div class="h-8 bg-slate-100 rounded w-full"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="py-20 bg-white relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Nh·∫≠t K√Ω ƒê·ªçc & H·ªçc T·∫≠p</h2>
        <p class="text-slate-600 max-w-2xl mx-auto">Ghi l·∫°i chi ti·∫øt nh·ªØng g√¨ b·∫°n ƒë√£ ti√™u th·ª• trong ng√†y ƒë·ªÉ th·∫•y s·ª± ti·∫øn b·ªô r√µ r·ªát.</p>
      </div>

      <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
        <div class="grid grid-cols-1 lg:grid-cols-12">

          <!-- Sidebar -->
          <div class="lg:col-span-4 bg-slate-50 p-8 border-b lg:border-b-0 lg:border-r border-slate-100">

            <!-- AI Card -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl p-6 text-white mb-8 shadow-lg relative overflow-hidden group">
              <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center">
                  <i class="fas fa-robot text-white text-lg"></i>
                </div>
                <h3 class="font-bold text-lg">AI Coach ƒê·ªÅ Xu·∫•t</h3>
              </div>

              <div id="ai-content" class="min-h-[60px] text-indigo-100 text-sm leading-relaxed mb-4">
                Ch∆∞a bi·∫øt h·ªçc g√¨ h√¥m nay? ƒê·ªÉ AI ph√¢n t√≠ch v√† g·ª£i √Ω b√†i h·ªçc t·ªëi ∆∞u cho b·∫°n nh√©!
              </div>

              <button onclick="getAISuggestion()"
                class="w-full bg-white text-indigo-600 font-bold py-2.5 rounded-lg hover:bg-indigo-50 transition shadow-md flex items-center justify-center gap-2 group-hover:scale-[1.02] duration-200">
                <i class="fas fa-magic"></i>
                <span>T·∫°o g·ª£i √Ω m·ªõi</span>
              </button>

              <div class="mt-3 text-xs text-white/80">
                <i class="fas fa-shield-halved mr-1"></i> API key ch·ªâ n·∫±m ·ªü server Vercel (ENV)
              </div>
            </div>

            <!-- Cloud controls -->
            <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-6">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-cloud text-indigo-600"></i> Cloud Sync
                  </div>
                  <div id="cloud-status" class="text-xs text-slate-500 mt-1">Ch∆∞a ƒë·ªìng b·ªô</div>
                </div>
                <div class="flex gap-2">
                  <button onclick="syncToCloud()" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700">
                    <i class="fas fa-cloud-arrow-up mr-1"></i> L∆∞u
                  </button>
                  <button onclick="syncFromCloud()" class="px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 text-sm font-bold hover:bg-indigo-100 border border-indigo-100">
                    <i class="fas fa-cloud-arrow-down mr-1"></i> T·∫£i
                  </button>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-500">
                M·∫πo: Sau khi ghi th√™m log, b·∫•m <b>L∆∞u</b> ƒë·ªÉ ƒë·∫©y l√™n Vercel KV.
              </div>
            </div>

            <div class="flex items-center gap-3 mb-6">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fas fa-plus"></i>
              </div>
              <h3 class="font-bold text-xl text-indigo-900">Ghi ch√∫ h√¥m nay</h3>
            </div>

            <form id="trackerForm" onsubmit="addLog(event)" class="space-y-5">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Ng√†y th√°ng</label>
                <input type="date" id="logDate"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-white">
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">K·ªπ nƒÉng / Ho·∫°t ƒë·ªông</label>
                <select id="logSkill"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white">
                  <option value="Reading">üìñ Reading (ƒê·ªçc b√°o/s√°ch)</option>
                  <option value="Listening">üéß Listening (Podcast/Video)</option>
                  <option value="Vocab">üî§ Vocabulary (H·ªçc t·ª´ m·ªõi)</option>
                  <option value="Writing">‚úçÔ∏è Writing (Vi·∫øt nh·∫≠t k√Ω/Essay)</option>
                  <option value="Speaking">üó£Ô∏è Speaking (Luy·ªán n√≥i)</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">N·ªôi dung chi ti·∫øt</label>
                <textarea id="logContent" rows="3" placeholder="VD: ƒê·ªçc b√†i v·ªÅ M√¥i tr∆∞·ªùng tr√™n BBC News..."
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white"></textarea>
                <p class="text-xs text-slate-500 mt-1">Ghi l·∫°i ti√™u ƒë·ªÅ b√†i b√°o ho·∫∑c ch·ªß ƒë·ªÅ ƒë√£ h·ªçc.</p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Th·ªùi gian (ph√∫t)</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="logTime" placeholder="30"
                    class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white">
                  <span class="text-slate-500 font-medium">ph√∫t</span>
                </div>
              </div>

              <button type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition transform hover:-translate-y-0.5">
                <i class="fas fa-save mr-2"></i> L∆∞u v√†o nh·∫≠t k√Ω (Local)
              </button>

              <button type="button" onclick="clearLocalLogs()"
                class="w-full bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 font-bold py-3 rounded-xl shadow-sm transition">
                <i class="fas fa-trash mr-2 text-red-500"></i> X√≥a nh·∫≠t k√Ω Local
              </button>

              <button type="button" onclick="clearCloudLogs()"
                class="w-full bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 font-bold py-3 rounded-xl shadow-sm transition">
                <i class="fas fa-cloud-bolt mr-2 text-red-500"></i> X√≥a nh·∫≠t k√Ω Cloud (Vercel)
              </button>
            </form>
          </div>

          <!-- Table -->
          <div class="lg:col-span-8 p-0 lg:p-8">
            <div class="p-6 lg:p-0">
              <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                  <i class="fas fa-table text-slate-400"></i> L·ªãch s·ª≠ h·ªçc t·∫≠p
                </h3>
              </div>

              <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm max-h-[600px] overflow-y-auto">
                <table class="w-full text-left border-collapse sheet-table bg-white relative">
                  <thead class="sticky top-0 z-10">
                    <tr>
                      <th class="w-32 shadow-sm">Ng√†y</th>
                      <th class="w-32 shadow-sm">Ho·∫°t ƒë·ªông</th>
                      <th class="shadow-sm">N·ªôi dung ƒë√£ h·ªçc/ƒë·ªçc</th>
                      <th class="w-24 text-center shadow-sm">Th·ªùi gian</th>
                      <th class="w-24 text-center shadow-sm">Tr·∫°ng th√°i</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody"></tbody>
                </table>
              </div>

              <div class="mt-4 text-xs text-slate-500">
                <i class="fas fa-circle-info mr-1"></i>
                Local = l∆∞u tr√™n tr√¨nh duy·ªát. Cloud = l∆∞u tr√™n Vercel KV.
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </section>

  <!-- Review -->
  <section id="review" class="py-16 bg-slate-50 border-t border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-end mb-10">
        <div class="mb-4 md:mb-0">
          <h2 class="text-3xl font-bold text-slate-900">Review Ch·∫∑ng ƒê∆∞·ªùng</h2>
          <p class="text-slate-600 mt-2">Nh√¨n l·∫°i nh·ªØng g√¨ b·∫°n ƒë√£ t√≠ch l≈©y ƒë∆∞·ª£c theo th·ªùi gian.</p>
        </div>
        <button onclick="generateReport()"
          class="bg-white border border-slate-200 text-indigo-600 px-6 py-2.5 rounded-xl font-bold shadow-sm hover:shadow-md transition flex items-center gap-2">
          <i class="fas fa-sync-alt"></i> C·∫≠p nh·∫≠t b√°o c√°o
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
          <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            <i class="fas fa-chart-bar text-indigo-500"></i> Ph√¢n b·ªï th·ªùi gian h·ªçc
          </h3>

          <div class="space-y-6">
            <div>
              <div class="flex justify-between text-sm font-medium mb-2">
                <span class="text-slate-700">Reading</span>
                <span class="text-slate-500" id="stat-reading-time">0 ph√∫t</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="bar-reading" class="skill-progress-bar h-3 bg-blue-500 rounded-full" style="width: 0%"></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm font-medium mb-2">
                <span class="text-slate-700">Listening</span>
                <span class="text-slate-500" id="stat-listening-time">0 ph√∫t</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="bar-listening" class="skill-progress-bar h-3 bg-teal-500 rounded-full" style="width: 0%"></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm font-medium mb-2">
                <span class="text-slate-700">Vocabulary</span>
                <span class="text-slate-500" id="stat-vocab-time">0 ph√∫t</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="bar-vocab" class="skill-progress-bar h-3 bg-amber-500 rounded-full" style="width: 0%"></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm font-medium mb-2">
                <span class="text-slate-700">Writing</span>
                <span class="text-slate-500" id="stat-writing-time">0 ph√∫t</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="bar-writing" class="skill-progress-bar h-3 bg-pink-500 rounded-full" style="width: 0%"></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm font-medium mb-2">
                <span class="text-slate-700">Speaking</span>
                <span class="text-slate-500" id="stat-speaking-time">0 ph√∫t</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="bar-speaking" class="skill-progress-bar h-3 bg-purple-500 rounded-full" style="width: 0%"></div>
              </div>
            </div>

          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
          <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            <i class="fas fa-history text-indigo-500"></i> ƒêi·ªÉm l·∫°i ki·∫øn th·ª©c (Highlights)
          </h3>
          <div class="relative border-l-2 border-indigo-100 ml-3 space-y-8" id="journey-timeline"></div>
          <div class="mt-8 pt-6 border-t border-slate-100">
            <div class="bg-indigo-50 rounded-lg p-4">
              <p class="text-sm text-indigo-800 italic">
                <i class="fas fa-quote-left mr-2"></i>
                "Th√†nh c√¥ng l√† t·ªïng h·ª£p c·ªßa nh·ªØng n·ªó l·ª±c nh·ªè b√©, l·∫∑p l·∫°i ng√†y n√†y qua ng√†y kh√°c."
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <script>
    // ---------------------------
    // UI helpers
    // ---------------------------
    function toggleMobileMenu() {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    }

    window.addEventListener('scroll', () => {
      const navbar = document.getElementById('navbar');
      if (window.scrollY > 10) navbar.classList.add('shadow-md');
      else navbar.classList.remove('shadow-md');
    });

    // default date
    document.getElementById('logDate').valueAsDate = new Date();

    // ---------------------------
    // Local + Cloud storage
    // ---------------------------
    const LS_KEY = "ieltsflow_logs_v2";
    const USER_ID = "default"; // sau n√†y c√≥ login th√¨ ƒë·ªïi theo user/email

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setCloudStatus(text, type="info") {
      const el = document.getElementById("cloud-status");
      el.textContent = text;
      el.className = "text-xs mt-1 " + (type==="ok" ? "text-green-600" : type==="err" ? "text-red-600" : "text-slate-500");
    }

    function loadLocalLogs() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    }

    function saveLocalLogs(logs) {
      localStorage.setItem(LS_KEY, JSON.stringify(logs));
    }

    async function loadCloudLogs() {
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`, { method: "GET" });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud GET failed");
      return Array.isArray(data.logs) ? data.logs : [];
    }

    async function saveCloudLogs(logs) {
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ logs })
      });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud POST failed");
      return data.saved || 0;
    }

    async function deleteCloudLogs() {
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`, { method: "DELETE" });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud DELETE failed");
      return true;
    }

    // ---------------------------
    // Render table
    // ---------------------------
    function badgeForSkill(skill) {
      let badgeClass = "bg-slate-100 text-slate-700";
      let icon = "fas fa-book";
      if(skill === 'Reading') { badgeClass = "bg-blue-100 text-blue-700"; icon = "fas fa-book-open"; }
      else if(skill === 'Listening') { badgeClass = "bg-teal-100 text-teal-700"; icon = "fas fa-headphones"; }
      else if(skill === 'Vocab') { badgeClass = "bg-amber-100 text-amber-700"; icon = "fas fa-font"; }
      else if(skill === 'Writing') { badgeClass = "bg-pink-100 text-pink-700"; icon = "fas fa-pen-nib"; }
      else if(skill === 'Speaking') { badgeClass = "bg-purple-100 text-purple-700"; icon = "fas fa-microphone"; }
      return { badgeClass, icon };
    }

    function renderLogsToTable(logs) {
      const tbody = document.getElementById("logTableBody");
      tbody.innerHTML = "";

      logs.forEach(item => {
        const { badgeClass, icon } = badgeForSkill(item.skill);

        const tr = document.createElement("tr");
        tr.classList.add("animate-fade-in");
        tr.setAttribute("data-skill", item.skill);
        tr.setAttribute("data-time", String(item.time || 0));

        tr.innerHTML = `
          <td class="font-medium text-slate-700">${escapeHtml(item.date)}</td>
          <td>
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium ${badgeClass}">
              <i class="${icon}"></i> ${escapeHtml(item.skill)}
            </span>
          </td>
          <td>${escapeHtml(item.content)}</td>
          <td class="text-center font-bold text-slate-600">${escapeHtml(String(item.time))}p</td>
          <td class="text-center"><i class="fas fa-check-circle text-green-500 text-lg"></i></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function collectLogsFromTable() {
      const rows = document.querySelectorAll("#logTableBody tr");
      const logs = [];
      rows.forEach(row => {
        const date = row.cells?.[0]?.innerText?.trim() || "";
        const skill = row.getAttribute("data-skill") || "";
        const content = row.cells?.[2]?.innerText?.trim() || "";
        const time = parseInt(row.getAttribute("data-time")) || 0;
        logs.push({ date, skill, content, time });
      });
      return logs;
    }

    // ---------------------------
    // Add log (local first, optional cloud sync)
    // ---------------------------
    function addLog(event) {
      event.preventDefault();

      const date = document.getElementById('logDate').value;
      const skill = document.getElementById('logSkill').value;
      const content = document.getElementById('logContent').value.trim();
      const time = parseInt(document.getElementById('logTime').value) || 0;

      if (!date || !content || !time) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      const formattedDate = new Date(date).toLocaleDateString('vi-VN');

      const logs = loadLocalLogs();
      logs.unshift({ date: formattedDate, skill, content, time });
      saveLocalLogs(logs);

      renderLogsToTable(logs);
      updateReviewStats();

      document.getElementById('trackerForm').reset();
      document.getElementById('logDate').valueAsDate = new Date();
      setCloudStatus("ƒê√£ l∆∞u Local. B·∫•m 'L∆∞u' ƒë·ªÉ ƒë·∫©y l√™n Cloud.", "info");
    }

    function clearLocalLogs() {
      if (!confirm("X√≥a to√†n b·ªô nh·∫≠t k√Ω Local tr√™n tr√¨nh duy·ªát n√†y?")) return;
      localStorage.removeItem(LS_KEY);
      renderLogsToTable([]);
      updateReviewStats();
      setCloudStatus("ƒê√£ x√≥a Local.", "info");
    }

    async function clearCloudLogs() {
      if (!confirm("X√≥a to√†n b·ªô nh·∫≠t k√Ω Cloud tr√™n Vercel?")) return;
      try {
        setCloudStatus("ƒêang x√≥a Cloud...", "info");
        await deleteCloudLogs();
        setCloudStatus("ƒê√£ x√≥a Cloud.", "ok");
      } catch (e) {
        setCloudStatus("L·ªói x√≥a Cloud: " + String(e.message || e), "err");
      }
    }

    // ---------------------------
    // Cloud sync
    // ---------------------------
    async function syncToCloud() {
      try {
        setCloudStatus("ƒêang l∆∞u l√™n Cloud...", "info");
        const logs = loadLocalLogs();
        const saved = await saveCloudLogs(logs);
        setCloudStatus(`ƒê√£ l∆∞u Cloud (${saved} d√≤ng).`, "ok");
      } catch (e) {
        setCloudStatus("L·ªói l∆∞u Cloud: " + String(e.message || e), "err");
      }
    }

    async function syncFromCloud() {
      try {
        setCloudStatus("ƒêang t·∫£i t·ª´ Cloud...", "info");
        const cloudLogs = await loadCloudLogs();
        saveLocalLogs(cloudLogs);
        renderLogsToTable(cloudLogs);
        updateReviewStats();
        setCloudStatus(`ƒê√£ t·∫£i Cloud (${cloudLogs.length} d√≤ng).`, "ok");
      } catch (e) {
        setCloudStatus("L·ªói t·∫£i Cloud: " + String(e.message || e), "err");
      }
    }

    // ---------------------------
    // AI Suggestion (server)
    // ---------------------------
    async function getAISuggestion() {
      const contentDiv = document.getElementById('ai-content');
      const btn = document.querySelector('button[onclick="getAISuggestion()"]');

      contentDiv.innerHTML = '<div class="flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> ƒêang g·ªçi AI Coach t·ª´ server...</div>';
      btn.disabled = true;
      btn.classList.add('opacity-75', 'cursor-not-allowed');

      try {
        const logs = collectLogsFromTable();

        const resp = await fetch("/api/ai-suggestion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            logs,
            userGoal: "IELTS 5.0 to 6.0 (focus Reading + Listening + Vocab)",
            band: "5.0‚Üí6.0"
          })
        });

        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data?.error || "Request failed");

        const s = data.suggestion;
        if (s && s.skill) {
          contentDiv.innerHTML = `
            <div class="animate-fade-in">
              <span class="block font-bold text-white mb-1 flex items-center gap-2">
                <i class="fas fa-robot"></i> ${escapeHtml(s.skill)}: ${escapeHtml(s.title || "G·ª£i √Ω h√¥m nay")}
              </span>
              <div class="text-indigo-100 text-sm leading-relaxed">
                <div class="mb-2">${escapeHtml(s.instruction || "")}</div>
                <div class="text-white/90 text-xs mb-2">‚è± ${escapeHtml(String(s.estimated_minutes || 20))} ph√∫t</div>
                <div class="text-white/80 text-xs mb-3">V√¨ sao: ${escapeHtml(s.reason || "")}</div>
                ${Array.isArray(s.followup_checklist) ? `
                  <ul class="list-disc pl-5 text-indigo-100 text-xs space-y-1">
                    ${s.followup_checklist.map(x => `<li>${escapeHtml(x)}</li>`).join("")}
                  </ul>
                ` : ``}
              </div>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="animate-fade-in text-indigo-100 text-sm leading-relaxed">
              ${data.raw ? escapeHtml(data.raw).replaceAll("\n", "<br/>") : "AI tr·∫£ k·∫øt qu·∫£ nh∆∞ng kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng."}
            </div>
          `;
        }
      } catch (e) {
        contentDiv.innerHTML = `
          <div class="animate-fade-in text-red-100 text-sm">
            ‚ùå L·ªói g·ªçi AI: ${escapeHtml(String(e.message || e))}
            <div class="text-indigo-100 text-xs mt-2">
              Ki·ªÉm tra ENV OPENAI_API_KEY tr√™n Vercel v√† file api/ai-suggestion.js
            </div>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    }

    // ---------------------------
    // Review
    // ---------------------------
    function generateReport() {
      updateReviewStats();
      const btn = document.querySelector('button[onclick="generateReport()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check text-green-500"></i> ƒê√£ c·∫≠p nh·∫≠t';
      setTimeout(() => btn.innerHTML = originalText, 2000);
    }

    function updateReviewStats() {
      const rows = document.querySelectorAll('#logTableBody tr');
      let stats = { Reading: 0, Listening: 0, Vocab: 0, Writing: 0, Speaking: 0 };
      let totalTime = 0;
      let recentContent = [];

      rows.forEach((row, index) => {
        const skill = row.getAttribute('data-skill');
        const time = parseInt(row.getAttribute('data-time')) || 0;
        const content = row.cells[2]?.innerText || "";

        if (stats.hasOwnProperty(skill)) {
          stats[skill] += time;
          totalTime += time;
        }
        if (index < 3) recentContent.push({ skill, content });
      });

      for (const [skill, time] of Object.entries(stats)) {
        const bar = document.getElementById(`bar-${skill.toLowerCase()}`);
        const text = document.getElementById(`stat-${skill.toLowerCase()}-time`);
        if (bar && text) {
          const percentage = totalTime > 0 ? (time / totalTime) * 100 : 0;
          bar.style.width = `${percentage}%`;
          text.innerText = `${time} ph√∫t`;
        }
      }

      const timeline = document.getElementById('journey-timeline');
      timeline.innerHTML = "";
      const colorMap = { Reading:'bg-blue-500', Listening:'bg-teal-500', Vocab:'bg-amber-500', Writing:'bg-pink-500', Speaking:'bg-purple-500' };

      if (recentContent.length === 0) {
        timeline.innerHTML = `
          <div class="ml-6 relative animate-fade-in">
            <span class="absolute -left-[31px] top-1 w-4 h-4 rounded-full bg-indigo-600 border-2 border-white shadow"></span>
            <h4 class="font-bold text-slate-800">Ch∆∞a c√≥ d·ªØ li·ªáu</h4>
            <p class="text-sm text-slate-500 mt-1">H√£y ghi m·ªôt ho·∫°t ƒë·ªông ƒë·ªÉ h·ªá th·ªëng b·∫Øt ƒë·∫ßu t·ªïng h·ª£p.</p>
          </div>
        `;
      } else {
        recentContent.forEach(item => {
          const color = colorMap[item.skill] || 'bg-indigo-600';
          timeline.innerHTML += `
            <div class="ml-6 relative animate-fade-in">
              <span class="absolute -left-[31px] top-1 w-4 h-4 rounded-full ${color} border-2 border-white shadow"></span>
              <h4 class="font-bold text-slate-800">${escapeHtml(item.skill)} Focus</h4>
              <p class="text-sm text-slate-500 mt-1">${escapeHtml(item.content)}</p>
            </div>
          `;
        });
      }
    }

    // ---------------------------
    // Init: ∆∞u ti√™n load Cloud -> fallback Local
    // ---------------------------
    window.addEventListener("load", async () => {
      try {
        setCloudStatus("ƒêang t·∫£i Cloud khi m·ªü trang...", "info");
        const cloudLogs = await loadCloudLogs();
        saveLocalLogs(cloudLogs);
        renderLogsToTable(cloudLogs);
        updateReviewStats();
        setCloudStatus(`ƒê√£ t·∫£i Cloud (${cloudLogs.length} d√≤ng).`, "ok");
      } catch (e) {
        // fallback local
        const localLogs = loadLocalLogs();
        renderLogsToTable(localLogs);
        updateReviewStats();
        setCloudStatus("Kh√¥ng t·∫£i ƒë∆∞·ª£c Cloud, d√πng Local.", "err");
      }
    });
  </script>
</body>
</html>
