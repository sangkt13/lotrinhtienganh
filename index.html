<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS Tracker Pro - Nh·∫≠t K√Ω & Review</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Quicksand', sans-serif; scroll-behavior: smooth; }
    .blob-shape { animation: morph 8s ease-in-out infinite; border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
    @keyframes morph {
      0% { border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
      50% { border-radius: 30% 60% 70% 40%/50% 60% 30% 60%; }
      100% { border-radius: 60% 40% 30% 70%/60% 30% 70% 40%; }
    }
    .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .nav-item { position: relative; }
    .nav-item::after { content:''; position:absolute; width:0; height:2px; bottom:-4px; left:0; background-color:#4F46E5; transition:width .3s ease-in-out; }
    .nav-item:hover::after { width:100%; }

    .sheet-table th {
      background:#F8FAFC; color:#64748B; font-weight:600; text-transform:uppercase;
      font-size:.75rem; letter-spacing:.05em; padding:12px 16px; border-bottom:2px solid #E2E8F0;
    }
    .sheet-table td { padding:16px; border-bottom:1px solid #F1F5F9; color:#334155; font-size:.9rem; }
    .sheet-table tr:last-child td { border-bottom:none; }
    .sheet-table tr:hover { background:#F8FAFC; }

    @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
    .animate-fade-in { animation: fadeIn .5s ease-out forwards; }
    .skill-progress-bar { transition: width 1s ease-in-out; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- Navbar -->
  <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md shadow-sm transition-all duration-300" id="navbar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex-shrink-0 flex items-center gap-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
            <i class="fa-solid fa-graduation-cap"></i>
          </div>
          <span class="font-bold text-2xl text-slate-800 tracking-tight">IELTS<span class="text-indigo-600">Flow</span></span>
        </div>

        <div class="hidden md:flex space-x-8">
          <a href="#" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">Trang ch·ªß</a>
          <a href="#dashboard" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">Nh·∫≠t k√Ω</a>
          <a href="#review" class="nav-item text-indigo-600 font-bold transition"><i class="fas fa-chart-pie mr-1"></i>Review</a>
          <a href="#roadmap" class="nav-item text-slate-600 hover:text-indigo-600 font-medium transition">L·ªô tr√¨nh</a>
        </div>

        <div class="md:hidden flex items-center">
          <button onclick="toggleMobileMenu()" class="text-slate-600 hover:text-indigo-600">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100 p-4 space-y-3">
      <a href="#" class="block text-slate-600 hover:text-indigo-600 font-medium">Trang ch·ªß</a>
      <a href="#dashboard" class="block text-slate-600 hover:text-indigo-600 font-medium">Nh·∫≠t k√Ω</a>
      <a href="#review" class="block text-indigo-600 font-bold">Review</a>
      <a href="#roadmap" class="block text-slate-600 hover:text-indigo-600 font-medium">L·ªô tr√¨nh</a>
    </div>
  </nav>

  <!-- Hero -->
  <section class="pt-32 pb-16 overflow-hidden relative">
    <div class="absolute top-0 right-0 -mr-20 -mt-20 w-96 h-96 bg-indigo-100 rounded-full blur-3xl opacity-50"></div>
    <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-80 h-80 bg-teal-100 rounded-full blur-3xl opacity-50"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <div class="space-y-6">
          <div class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-sm font-semibold border border-indigo-100">
            ‚òÅÔ∏è L∆∞u nh·∫≠t k√Ω tr√™n Vercel Blob
          </div>

          <h1 class="text-4xl lg:text-5xl font-bold leading-tight text-slate-900">
            IELTSFlow<br>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-teal-500">Tracking + Cloud + AI</span>
          </h1>

          <p class="text-lg text-slate-600 leading-relaxed">
            Ghi nh·∫≠t k√Ω h·ªçc IELTS v√† l∆∞u l√™n cloud (Vercel Blob). AI g·ª£i √Ω b√†i h·ªçc d·ª±a tr√™n d·ªØ li·ªáu th·∫≠t.
          </p>

          <div class="flex flex-col sm:flex-row gap-3">
            <button onclick="document.getElementById('dashboard').scrollIntoView({behavior:'smooth'})"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-7 py-3.5 rounded-xl font-bold shadow-xl shadow-indigo-500/30 transition">
              <i class="fas fa-pen-nib mr-2"></i>B·∫Øt ƒë·∫ßu ghi ch√©p
            </button>

            <button onclick="syncFromCloud()"
              class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-7 py-3.5 rounded-xl font-bold shadow-sm transition">
              <i class="fas fa-cloud-arrow-down text-indigo-600 mr-2"></i>T·∫£i t·ª´ Blob
            </button>
          </div>

          <div class="text-sm text-slate-500">
            <i class="fas fa-circle-info mr-1"></i>
            L∆∞u d·∫°ng file JSON: <b>ieltsflow/logs/default.json</b>
          </div>
        </div>

        <div class="relative lg:h-[480px] flex items-center justify-center">
          <div class="absolute w-full h-full bg-gradient-to-tr from-indigo-200 to-teal-100 blob-shape opacity-60"></div>
          <div class="relative z-10 w-full max-w-lg glass-card p-4 rounded-2xl shadow-2xl">
            <div class="bg-white rounded-xl p-6">
              <div class="flex items-center gap-2 border-b pb-4 mb-4">
                <i class="fas fa-calendar-check text-indigo-600"></i>
                <span class="font-bold text-slate-700">Daily Habit Tracker</span>
              </div>
              <div class="space-y-3">
                <div class="h-8 bg-slate-100 rounded w-full"></div>
                <div class="h-8 bg-slate-100 rounded w-5/6"></div>
                <div class="h-8 bg-slate-100 rounded w-full"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="py-16 bg-white relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <div class="text-center mb-10">
        <h2 class="text-3xl font-bold text-slate-900 mb-3">Nh·∫≠t K√Ω ƒê·ªçc & H·ªçc T·∫≠p</h2>
        <p class="text-slate-600 max-w-2xl mx-auto">Local + Cloud (Vercel Blob) + AI Suggestion.</p>
      </div>

      <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
        <div class="grid grid-cols-1 lg:grid-cols-12">

          <!-- Sidebar -->
          <div class="lg:col-span-4 bg-slate-50 p-7 border-b lg:border-b-0 lg:border-r border-slate-100">

            <!-- AI -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl p-6 text-white mb-6 shadow-lg">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-robot text-white text-lg"></i>
                </div>
                <h3 class="font-bold text-lg">AI Coach ƒê·ªÅ Xu·∫•t</h3>
              </div>

              <div id="ai-content" class="min-h-[60px] text-indigo-100 text-sm leading-relaxed mb-4">
                B·∫•m ƒë·ªÉ AI g·ª£i √Ω b√†i h·ªçc d·ª±a tr√™n nh·∫≠t k√Ω c·ªßa b·∫°n.
              </div>

              <button onclick="getAISuggestion()"
                class="w-full bg-white text-indigo-600 font-bold py-2.5 rounded-lg hover:bg-indigo-50 transition shadow-md">
                <i class="fas fa-magic mr-2"></i>T·∫°o g·ª£i √Ω m·ªõi
              </button>

              <div class="mt-3 text-xs text-white/80">
                <i class="fas fa-shield-halved mr-1"></i> OPENAI_API_KEY ch·ªâ l∆∞u ·ªü ENV Vercel
              </div>
            </div>

            <!-- Cloud -->
            <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-6">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-cloud text-indigo-600"></i> Blob Sync
                  </div>
                  <div id="cloud-status" class="text-xs text-slate-500 mt-1">Ch∆∞a ƒë·ªìng b·ªô</div>
                </div>
                <div class="flex gap-2">
                  <button onclick="syncToCloud()"
                    class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700">
                    <i class="fas fa-cloud-arrow-up mr-1"></i> L∆∞u
                  </button>
                  <button onclick="syncFromCloud()"
                    class="px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 text-sm font-bold hover:bg-indigo-100 border border-indigo-100">
                    <i class="fas fa-cloud-arrow-down mr-1"></i> T·∫£i
                  </button>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-500">
                Cloud l∆∞u 1 file JSON tr√™n Blob. B·∫•m <b>L∆∞u</b> sau khi th√™m log.
              </div>
            </div>

            <!-- Form -->
            <form id="trackerForm" onsubmit="addLog(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Ng√†y th√°ng</label>
                <input type="date" id="logDate"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">K·ªπ nƒÉng / Ho·∫°t ƒë·ªông</label>
                <select id="logSkill"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                  <option value="Reading">üìñ Reading</option>
                  <option value="Listening">üéß Listening</option>
                  <option value="Vocab">üî§ Vocabulary</option>
                  <option value="Writing">‚úçÔ∏è Writing</option>
                  <option value="Speaking">üó£Ô∏è Speaking</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">N·ªôi dung chi ti·∫øt</label>
                <textarea id="logContent" rows="3"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
                  placeholder="VD: ƒê·ªçc b√†i BBC v·ªÅ Education..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Th·ªùi gian (ph√∫t)</label>
                <input type="number" id="logTime"
                  class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
                  placeholder="30">
              </div>

              <button type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition">
                <i class="fas fa-save mr-2"></i> L∆∞u nh·∫≠t k√Ω (Local)
              </button>

              <button type="button" onclick="clearLocalLogs()"
                class="w-full bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 font-bold py-3 rounded-xl shadow-sm transition">
                <i class="fas fa-trash mr-2 text-red-500"></i> X√≥a Local
              </button>

              <button type="button" onclick="clearCloudLogs()"
                class="w-full bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 font-bold py-3 rounded-xl shadow-sm transition">
                <i class="fas fa-cloud-bolt mr-2 text-red-500"></i> X√≥a Blob
              </button>
            </form>
          </div>

          <!-- Table -->
          <div class="lg:col-span-8 p-6 lg:p-8">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                <i class="fas fa-table text-slate-400"></i> L·ªãch s·ª≠ h·ªçc t·∫≠p
              </h3>
            </div>

            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm max-h-[600px] overflow-y-auto">
              <table class="w-full text-left border-collapse sheet-table bg-white relative">
                <thead class="sticky top-0 z-10">
                  <tr>
                    <th class="w-32 shadow-sm">Ng√†y</th>
                    <th class="w-32 shadow-sm">Ho·∫°t ƒë·ªông</th>
                    <th class="shadow-sm">N·ªôi dung</th>
                    <th class="w-24 text-center shadow-sm">Th·ªùi gian</th>
                    <th class="w-24 text-center shadow-sm">OK</th>
                  </tr>
                </thead>
                <tbody id="logTableBody"></tbody>
              </table>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              <i class="fas fa-circle-info mr-1"></i>
              Local l∆∞u trong tr√¨nh duy·ªát, Blob l∆∞u file JSON tr√™n Vercel.
            </div>
          </div>

        </div>
      </div>

      <!-- Review -->
      <div id="review" class="mt-12 bg-slate-50 border border-slate-200 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h3 class="text-2xl font-bold text-slate-900">Review Ch·∫∑ng ƒê∆∞·ªùng</h3>
            <p class="text-slate-600 text-sm mt-1">T·ªïng h·ª£p t·ª± ƒë·ªông t·ª´ b·∫£ng nh·∫≠t k√Ω.</p>
          </div>
          <button onclick="generateReport()"
            class="bg-white border border-slate-200 text-indigo-600 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:shadow-md transition">
            <i class="fas fa-sync-alt mr-2"></i> C·∫≠p nh·∫≠t
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl p-6 border border-slate-100">
            <h4 class="font-bold text-slate-800 mb-4"><i class="fas fa-chart-bar text-indigo-500 mr-2"></i>Ph√¢n b·ªï th·ªùi gian</h4>

            <div class="space-y-4">
              <div>
                <div class="flex justify-between text-sm font-medium mb-2">
                  <span>Reading</span><span id="stat-reading-time" class="text-slate-500">0 ph√∫t</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div id="bar-reading" class="skill-progress-bar h-3 bg-blue-500 rounded-full" style="width:0%"></div>
                </div>
              </div>

              <div>
                <div class="flex justify-between text-sm font-medium mb-2">
                  <span>Listening</span><span id="stat-listening-time" class="text-slate-500">0 ph√∫t</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div id="bar-listening" class="skill-progress-bar h-3 bg-teal-500 rounded-full" style="width:0%"></div>
                </div>
              </div>

              <div>
                <div class="flex justify-between text-sm font-medium mb-2">
                  <span>Vocab</span><span id="stat-vocab-time" class="text-slate-500">0 ph√∫t</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div id="bar-vocab" class="skill-progress-bar h-3 bg-amber-500 rounded-full" style="width:0%"></div>
                </div>
              </div>

              <div>
                <div class="flex justify-between text-sm font-medium mb-2">
                  <span>Writing</span><span id="stat-writing-time" class="text-slate-500">0 ph√∫t</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div id="bar-writing" class="skill-progress-bar h-3 bg-pink-500 rounded-full" style="width:0%"></div>
                </div>
              </div>

              <div>
                <div class="flex justify-between text-sm font-medium mb-2">
                  <span>Speaking</span><span id="stat-speaking-time" class="text-slate-500">0 ph√∫t</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div id="bar-speaking" class="skill-progress-bar h-3 bg-purple-500 rounded-full" style="width:0%"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl p-6 border border-slate-100">
            <h4 class="font-bold text-slate-800 mb-4"><i class="fas fa-history text-indigo-500 mr-2"></i>Highlights (3 g·∫ßn nh·∫•t)</h4>
            <div class="relative border-l-2 border-indigo-100 ml-3 space-y-6" id="journey-timeline"></div>
          </div>
        </div>

      </div>

    </div>
  </section>

  <script>
    // UI
    function toggleMobileMenu(){ document.getElementById('mobile-menu').classList.toggle('hidden'); }
    window.addEventListener('scroll', () => {
      const navbar = document.getElementById('navbar');
      if (window.scrollY > 10) navbar.classList.add('shadow-md');
      else navbar.classList.remove('shadow-md');
    });

    // default date
    document.getElementById('logDate').valueAsDate = new Date();

    // Local + Cloud (Blob)
    const LS_KEY = "ieltsflow_logs_blob_v1";
    const USER_ID = "default";

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setCloudStatus(text, type="info") {
      const el = document.getElementById("cloud-status");
      el.textContent = text;
      el.className = "text-xs mt-1 " + (type==="ok" ? "text-green-600" : type==="err" ? "text-red-600" : "text-slate-500");
    }

    function loadLocalLogs(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch { return []; }
    }
    function saveLocalLogs(logs){ localStorage.setItem(LS_KEY, JSON.stringify(logs)); }

    async function loadCloudLogs(){
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`);
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud GET failed");
      return Array.isArray(data.logs) ? data.logs : [];
    }

    async function saveCloudLogs(logs){
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ logs })
      });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud POST failed");
      return data;
    }

    async function deleteCloudLogs(){
      const r = await fetch(`/api/logs?user=${encodeURIComponent(USER_ID)}`, { method:"DELETE" });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data?.error || "Cloud DELETE failed");
      return true;
    }

    function badgeForSkill(skill){
      let badgeClass="bg-slate-100 text-slate-700", icon="fas fa-book";
      if(skill==='Reading'){ badgeClass="bg-blue-100 text-blue-700"; icon="fas fa-book-open"; }
      else if(skill==='Listening'){ badgeClass="bg-teal-100 text-teal-700"; icon="fas fa-headphones"; }
      else if(skill==='Vocab'){ badgeClass="bg-amber-100 text-amber-700"; icon="fas fa-font"; }
      else if(skill==='Writing'){ badgeClass="bg-pink-100 text-pink-700"; icon="fas fa-pen-nib"; }
      else if(skill==='Speaking'){ badgeClass="bg-purple-100 text-purple-700"; icon="fas fa-microphone"; }
      return { badgeClass, icon };
    }

    function renderLogsToTable(logs){
      const tbody = document.getElementById("logTableBody");
      tbody.innerHTML = "";
      logs.forEach(item => {
        const { badgeClass, icon } = badgeForSkill(item.skill);
        const tr = document.createElement("tr");
        tr.classList.add("animate-fade-in");
        tr.setAttribute("data-skill", item.skill);
        tr.setAttribute("data-time", String(item.time||0));
        tr.innerHTML = `
          <td class="font-medium text-slate-700">${escapeHtml(item.date)}</td>
          <td><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium ${badgeClass}"><i class="${icon}"></i> ${escapeHtml(item.skill)}</span></td>
          <td>${escapeHtml(item.content)}</td>
          <td class="text-center font-bold text-slate-600">${escapeHtml(String(item.time))}p</td>
          <td class="text-center"><i class="fas fa-check-circle text-green-500 text-lg"></i></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function collectLogsFromTable(){
      const rows = document.querySelectorAll("#logTableBody tr");
      const logs = [];
      rows.forEach(row => {
        logs.push({
          date: row.cells?.[0]?.innerText?.trim() || "",
          skill: row.getAttribute("data-skill") || "",
          content: row.cells?.[2]?.innerText?.trim() || "",
          time: parseInt(row.getAttribute("data-time")) || 0
        });
      });
      return logs;
    }

    function addLog(event){
      event.preventDefault();
      const date = document.getElementById('logDate').value;
      const skill = document.getElementById('logSkill').value;
      const content = document.getElementById('logContent').value.trim();
      const time = parseInt(document.getElementById('logTime').value) || 0;

      if(!date || !content || !time){
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      const logs = loadLocalLogs();
      logs.unshift({ date: formattedDate, skill, content, time });
      saveLocalLogs(logs);

      renderLogsToTable(logs);
      updateReviewStats();
      document.getElementById('trackerForm').reset();
      document.getElementById('logDate').valueAsDate = new Date();

      setCloudStatus("ƒê√£ l∆∞u Local. B·∫•m 'L∆∞u' ƒë·ªÉ ƒë·∫©y l√™n Blob.", "info");
    }

    function clearLocalLogs(){
      if(!confirm("X√≥a to√†n b·ªô nh·∫≠t k√Ω Local?")) return;
      localStorage.removeItem(LS_KEY);
      renderLogsToTable([]);
      updateReviewStats();
      setCloudStatus("ƒê√£ x√≥a Local.", "info");
    }

    async function clearCloudLogs(){
      if(!confirm("X√≥a nh·∫≠t k√Ω tr√™n Blob?")) return;
      try{
        setCloudStatus("ƒêang x√≥a Blob...", "info");
        await deleteCloudLogs();
        setCloudStatus("ƒê√£ x√≥a Blob.", "ok");
      }catch(e){
        setCloudStatus("L·ªói x√≥a Blob: " + String(e.message||e), "err");
      }
    }

    async function syncToCloud(){
      try{
        setCloudStatus("ƒêang l∆∞u l√™n Blob...", "info");
        const logs = loadLocalLogs();
        const data = await saveCloudLogs(logs);
        setCloudStatus(`ƒê√£ l∆∞u Blob (${data.saved} d√≤ng).`, "ok");
      }catch(e){
        setCloudStatus("L·ªói l∆∞u Blob: " + String(e.message||e), "err");
      }
    }

    async function syncFromCloud(){
      try{
        setCloudStatus("ƒêang t·∫£i t·ª´ Blob...", "info");
        const logs = await loadCloudLogs();
        saveLocalLogs(logs);
        renderLogsToTable(logs);
        updateReviewStats();
        setCloudStatus(`ƒê√£ t·∫£i Blob (${logs.length} d√≤ng).`, "ok");
      }catch(e){
        setCloudStatus("L·ªói t·∫£i Blob: " + String(e.message||e), "err");
      }
    }

    async function getAISuggestion(){
      const contentDiv = document.getElementById('ai-content');
      const btn = document.querySelector('button[onclick="getAISuggestion()"]');

      contentDiv.innerHTML = '<div class="flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> ƒêang g·ªçi AI...</div>';
      btn.disabled = true; btn.classList.add('opacity-75','cursor-not-allowed');

      try{
        const logs = collectLogsFromTable();
        const resp = await fetch("/api/ai-suggestion", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ logs, userGoal:"IELTS 5.0‚Üí6.0", band:"5.0‚Üí6.0" })
        });
        const data = await resp.json();
        if(!resp.ok || !data.ok) throw new Error(data?.error || "AI request failed");

        const s = data.suggestion;
        if(s && s.skill){
          contentDiv.innerHTML = `
            <div class="animate-fade-in">
              <div class="font-bold text-white mb-1">${escapeHtml(s.skill)}: ${escapeHtml(s.title||"G·ª£i √Ω h√¥m nay")}</div>
              <div class="text-indigo-100 text-sm">${escapeHtml(s.instruction||"")}</div>
              <div class="text-white/90 text-xs mt-2">‚è± ${escapeHtml(String(s.estimated_minutes||20))} ph√∫t</div>
              <div class="text-white/80 text-xs mt-1">V√¨ sao: ${escapeHtml(s.reason||"")}</div>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `<div class="animate-fade-in text-indigo-100 text-sm">${escapeHtml(data.raw||"AI tr·∫£ k·∫øt qu·∫£.")}</div>`;
        }
      }catch(e){
        contentDiv.innerHTML = `<div class="animate-fade-in text-red-100 text-sm">‚ùå L·ªói AI: ${escapeHtml(String(e.message||e))}</div>`;
      }finally{
        btn.disabled = false; btn.classList.remove('opacity-75','cursor-not-allowed');
      }
    }

    function generateReport(){ updateReviewStats(); }

    function updateReviewStats(){
      const rows = document.querySelectorAll('#logTableBody tr');
      let stats = { Reading:0, Listening:0, Vocab:0, Writing:0, Speaking:0 };
      let totalTime = 0;
      let recent = [];

      rows.forEach((row, idx) => {
        const skill = row.getAttribute('data-skill');
        const time = parseInt(row.getAttribute('data-time')) || 0;
        const content = row.cells?.[2]?.innerText || "";
        if(stats.hasOwnProperty(skill)){ stats[skill]+=time; totalTime+=time; }
        if(idx < 3) recent.push({ skill, content });
      });

      for (const [skill, time] of Object.entries(stats)) {
        const bar = document.getElementById(`bar-${skill.toLowerCase()}`);
        const text = document.getElementById(`stat-${skill.toLowerCase()}-time`);
        if(bar && text){
          const pct = totalTime > 0 ? (time/totalTime)*100 : 0;
          bar.style.width = `${pct}%`;
          text.innerText = `${time} ph√∫t`;
        }
      }

      const timeline = document.getElementById('journey-timeline');
      timeline.innerHTML = "";
      const colorMap = { Reading:'bg-blue-500', Listening:'bg-teal-500', Vocab:'bg-amber-500', Writing:'bg-pink-500', Speaking:'bg-purple-500' };

      if(recent.length === 0){
        timeline.innerHTML = `
          <div class="ml-6 relative animate-fade-in">
            <span class="absolute -left-[31px] top-1 w-4 h-4 rounded-full bg-indigo-600 border-2 border-white shadow"></span>
            <h4 class="font-bold text-slate-800">Ch∆∞a c√≥ d·ªØ li·ªáu</h4>
            <p class="text-sm text-slate-500 mt-1">H√£y ghi m·ªôt ho·∫°t ƒë·ªông ƒë·ªÉ b·∫Øt ƒë·∫ßu th·ªëng k√™.</p>
          </div>`;
        return;
      }

      recent.forEach(item => {
        const color = colorMap[item.skill] || 'bg-indigo-600';
        timeline.innerHTML += `
          <div class="ml-6 relative animate-fade-in">
            <span class="absolute -left-[31px] top-1 w-4 h-4 rounded-full ${color} border-2 border-white shadow"></span>
            <h4 class="font-bold text-slate-800">${escapeHtml(item.skill)} Focus</h4>
            <p class="text-sm text-slate-500 mt-1">${escapeHtml(item.content)}</p>
          </div>`;
      });
    }

    // Init: try cloud first, fallback local
    window.addEventListener("load", async () => {
      try{
        setCloudStatus("ƒêang t·∫£i Blob khi m·ªü trang...", "info");
        const logs = await loadCloudLogs();
        saveLocalLogs(logs);
        renderLogsToTable(logs);
        updateReviewStats();
        setCloudStatus(`ƒê√£ t·∫£i Blob (${logs.length} d√≤ng).`, "ok");
      }catch(e){
        const logs = loadLocalLogs();
        renderLogsToTable(logs);
        updateReviewStats();
        setCloudStatus("Kh√¥ng t·∫£i ƒë∆∞·ª£c Blob, d√πng Local.", "err");
      }
    });
  </script>
</body>
</html>
